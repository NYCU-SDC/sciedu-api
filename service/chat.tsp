import "@typespec/http";
import "../main.tsp";

using Http;

namespace SciEdu.Chat;

@doc("The role of the message author.")
enum ChatRole {
  User: "user",
  Assistant: "assistant",
  System: "system",
}

@doc("A single message in the chat history.")
model ChatMessage {
  @doc("The role of the message sender.")
  role: ChatRole;

  @doc("The content of the message.")
  content: string;
}

@doc("Request payload for creating a chat completion.")
model CreateChatCompletionRequest {
  @doc("The history of the conversation, including the latest user message. The client is responsible for maintaining this context.")
  @minItems(1)
  messages: ChatMessage[];

  @doc("Whether to stream the response. Must be true for this user story.")
  stream?: boolean = true;
}

@doc("Represents a chunk of the streamed response.")
model ChatCompletionChunk {
  @doc("The text delta generated by the model.")
  delta: string;

  @doc("Indicates if the generation is finished.")
  isFinished: boolean;
}

@tag("Chat")
@route("/chat")
namespace Completions {
  // @summary("Stream Chat Completion")
  @doc("Generates a response based on the full conversation history provided. Returns a Server-Sent Events (SSE) stream.")
  @post
  @route("/completions")
  op create(@body body: CreateChatCompletionRequest): {
    @statusCode statusCode: 200;
    @header("Content-Type") contentType: "text/event-stream";
    @header("Cache-Control") cacheControl: "no-cache";
    @header("Connection") connection: "keep-alive";
    @body body: ChatCompletionChunk;
  } | {
    @statusCode statusCode: 400;
    @body error: SciEdu.ProblemDetail;
  } | {
    @statusCode statusCode: 401;
    @body error: SciEdu.Unauthorized;
  };
}
